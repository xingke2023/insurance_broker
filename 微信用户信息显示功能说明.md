# 微信用户信息显示功能说明

## 功能概述
实现了在 H5 网页中显示微信用户的昵称和头像功能。当用户通过微信授权登录后，系统会获取并显示用户的微信昵称和头像。

## 实现内容

### 1. 后端实现

#### 数据模型 (`api/models.py`)
`WeChatUser` 模型已包含以下字段：
- `nickname` - 微信昵称
- `avatar_url` - 微信头像URL
- `openid` - 微信OpenID
- `unionid` - UnionID（可选）

#### 新增接口

##### `/api/login/wechat-web` - 微信网页授权登录
**功能**：处理微信网页授权登录，获取用户信息

**请求方式**：POST

**请求参数**：
```json
{
  "code": "微信授权code"
}
```

**响应数据**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "JWT access token",
    "refresh": "JWT refresh token",
    "userInfo": {
      "id": 1,
      "username": "wx_xxxxx",
      "nickname": "微信昵称",
      "avatar": "https://wx.qlogo.cn/...",
      "full_name": "微信昵称"
    }
  }
}
```

**工作流程**：
1. 接收前端传来的微信授权 code
2. 调用微信 OAuth2 接口换取 access_token 和 openid
3. 使用 access_token 获取用户详细信息（昵称、头像等）
4. 查找或创建用户账号
5. 保存/更新微信用户信息
6. 返回 JWT token 和用户信息

#### 更新接口

##### `/api/auth/profile/` - 用户资料接口（已更新）
**新增返回字段**：
```json
{
  "id": 1,
  "username": "user123",
  "email": "user@example.com",
  "full_name": "用户名",
  "wechat": {                    // 新增
    "nickname": "微信昵称",      // 新增
    "avatar": "头像URL"         // 新增
  }
}
```

### 2. 前端实现

#### Dashboard 组件更新 (`frontend/src/components/Dashboard.jsx`)

**显示位置**：

1. **顶部导航栏**
   - 显示微信头像（如果有）
   - 显示微信昵称（优先）或用户名
   - 头像加载失败时显示默认头像

2. **欢迎消息**
   - 使用微信昵称（如果有）或用户全名

**代码实现**：
```jsx
{/* 头像显示 */}
{user?.wechat?.avatar ? (
  <img
    src={user.wechat.avatar}
    alt="avatar"
    className="h-8 w-8 sm:h-10 sm:w-10 rounded-full flex-shrink-0 shadow-lg object-cover"
    onError={(e) => {
      e.target.style.display = 'none';
      e.target.nextSibling.style.display = 'flex';
    }}
  />
) : null}

{/* 默认头像（当没有微信头像时） */}
<div
  className="h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600..."
  style={{display: user?.wechat?.avatar ? 'none' : 'flex'}}
>
  {(user?.wechat?.nickname || user?.username)?.charAt(0).toUpperCase()}
</div>

{/* 昵称显示 */}
<p className="text-xs sm:text-sm font-medium text-white truncate max-w-[120px]">
  {user?.wechat?.nickname || user?.full_name}
</p>
```

## 微信网页授权流程

### 1. 配置要求
需要在 Django settings 中配置：
```python
# 微信公众号配置（用于网页授权）
WECHAT_WEB_APP_ID = 'your_web_appid'
WECHAT_WEB_APP_SECRET = 'your_web_app_secret'

# 或者使用小程序配置
WECHAT_APP_ID = 'your_appid'
WECHAT_APP_SECRET = 'your_app_secret'
```

### 2. 授权流程

#### 方式一：在微信内置浏览器中（推荐）
1. 用户在微信中打开 H5 页面
2. 前端引导用户进行微信授权
3. 跳转到微信授权页面：
```javascript
const redirectUrl = encodeURIComponent('https://your-domain.com/auth/callback');
const scope = 'snsapi_userinfo'; // 获取用户详细信息
window.location.href = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${appid}&redirect_uri=${redirectUrl}&response_type=code&scope=${scope}&state=STATE#wechat_redirect`;
```

4. 用户同意授权后，微信会回调到指定URL并带上 code
5. 前端获取 code 后，调用后端接口 `/api/login/wechat-web`
6. 后端返回用户信息和 token
7. 前端保存 token 和用户信息，显示头像和昵称

#### 方式二：在小程序 WebView 中
小程序已经通过 `wx.login()` 获取了用户信息，可以直接使用小程序登录接口 `/api/login/wechat`

### 3. 授权 Scope 说明
- `snsapi_base`：静默授权，只能获取 openid，无法获取昵称和头像
- `snsapi_userinfo`：需要用户确认，可以获取昵称、头像等详细信息

## 数据流向

```
微信服务器
    ↓ (授权码 code)
前端页面
    ↓ (POST /api/login/wechat-web)
后端接口
    ↓ (换取 access_token 和用户信息)
微信服务器
    ↓ (用户信息)
后端数据库 (保存/更新)
    ↓ (返回 JWT token 和用户信息)
前端页面 (显示头像和昵称)
```

## 显示效果

### 有微信信息的用户
- **头像**：显示微信真实头像
- **昵称**：显示微信昵称
- **欢迎语**："欢迎回来，[微信昵称]！"

### 普通注册用户（无微信信息）
- **头像**：显示用户名首字母的彩色圆形头像
- **昵称**：显示用户注册时的全名或用户名
- **欢迎语**："欢迎回来，[用户全名]！"

## 注意事项

1. **微信公众号配置**
   - 需要认证的服务号才能使用网页授权
   - 需要在公众号后台配置授权回调域名
   - 域名必须是已备案的域名

2. **头像加载失败处理**
   - 微信头像URL可能失效或无法访问
   - 代码中已实现 onError 回退到默认头像
   - 默认头像显示用户昵称或用户名首字母

3. **隐私保护**
   - 微信头像URL只在有效期内可访问
   - 建议定期刷新用户信息
   - 不要将头像URL作为永久标识

4. **兼容性**
   - 支持微信内置浏览器
   - 支持小程序 WebView
   - 普通浏览器中可以使用微信扫码授权（需要开放平台）

## 测试步骤

### 在微信中测试
1. 在微信中打开 H5 页面
2. 触发微信授权登录流程
3. 同意授权
4. 登录成功后，查看 Dashboard 页面
5. 应该能看到：
   - 右上角显示微信头像
   - 显示微信昵称
   - 欢迎消息中使用微信昵称

### 在小程序中测试
1. 小程序登录
2. 打开 WebView 页面
3. 查看 Dashboard
4. 应该显示微信昵称和头像

## 相关文件

### 后端
- `/var/www/harry-insurance2/api/models.py:5-23` - WeChatUser 模型
- `/var/www/harry-insurance2/api/auth_views.py:374-519` - 微信网页授权接口
- `/var/www/harry-insurance2/api/auth_views.py:195-222` - 用户资料接口
- `/var/www/harry-insurance2/api/urls.py:25` - 路由配置

### 前端
- `/var/www/harry-insurance2/frontend/src/components/Dashboard.jsx:241-265` - 头像和昵称显示
- `/var/www/harry-insurance2/frontend/src/components/Dashboard.jsx:279-284` - 欢迎消息

## 扩展功能建议

1. **头像缓存**
   - 可以将微信头像下载到服务器
   - 避免外部链接失效

2. **用户信息更新**
   - 定期刷新用户的微信信息
   - 添加手动刷新功能

3. **多平台统一**
   - 支持 UnionID 实现多平台账号统一
   - 小程序、公众号、网页账号互通

4. **个性化设置**
   - 允许用户选择显示微信昵称或自定义昵称
   - 支持上传自定义头像
