# 个人语音创建说明

## ✅ 问题已解决

**问题：** 创建音色失败: InvalidURL - audio url should start with http or https

**原因：** 阿里云CosyVoice要求音频文件必须通过公网HTTP/HTTPS URL访问。

**解决方案：** 系统已自动配置，上传的音频文件会被保存到可公网访问的位置。

## 🎤 如何创建个人语音

### 方式一：通过前端界面（推荐）

1. 访问 Text-to-Speech 页面
2. 切换到"个人语音"标签
3. 点击"创建新语音"按钮
4. 填写以下信息：
   - **语音名称**：给你的语音起个名字（如"我的声音"）
   - **配音员姓名**：可选
   - **公司名称**：可选
5. **上传语音样本**：
   - 支持格式：WAV, MP3, M4A等
   - 推荐时长：10-60秒
   - 内容：朗读一段文字，确保音质清晰
6. 点击"创建"按钮
7. 等待处理（约30秒-5分钟）

### 方式二：通过API调用

#### 使用文件上传

```bash
curl -X POST https://hongkong.xingke888.com/api/personal-voice/create/ \
  -F "voice_name=我的专属声音" \
  -F "voice_talent_name=张三" \
  -F "company_name=我的公司" \
  -F "voice_sample=@/path/to/your/voice.mp3"
```

#### 使用公网URL

```bash
curl -X POST https://hongkong.xingke888.com/api/personal-voice/create/ \
  -F "voice_name=我的专属声音" \
  -F "voice_talent_name=张三" \
  -F "audio_url=https://example.com/my-voice.wav"
```

## 📋 音频要求

### 格式要求
- **支持格式**：WAV, MP3, M4A, AAC等常见格式
- **采样率**：任意（系统会自动转换为16kHz）
- **声道**：单声道或立体声（系统会自动转换为单声道）
- **位深度**：任意（系统会自动转换为16-bit）

### 内容要求
- **时长**：建议10-60秒
- **内容**：朗读一段流畅的文字
- **环境**：安静，无明显背景噪音
- **音质**：清晰，无失真或杂音
- **语速**：正常语速，不要过快或过慢

### 示例文本（可供朗读）

**中文：**
```
大家好，我是[你的名字]。今天天气真不错，
阳光明媚，心情也格外愉快。我喜欢在这样的
日子里出去散散步，感受大自然的美好。希望
每天都能拥有这样轻松愉快的心情。
```

**英文：**
```
Hello, my name is [your name]. Today is a beautiful day,
with sunshine and blue skies. I love going for walks on
days like this and enjoying the beauty of nature. I hope
every day can be as pleasant and relaxing as this one.
```

## ⚙️ 系统工作流程

1. **上传音频** → 系统保存到 `/media/personal_voices/[voice-id]/`
2. **格式转换** → FFmpeg转换为16kHz单声道WAV
3. **生成URL** → `https://hongkong.xingke888.com/media/personal_voices/[voice-id]/voice_sample.wav`
4. **提交阿里云** → 调用VoiceEnrollmentService.create_voice()
5. **轮询状态** → 每10秒检查一次，最多5分钟
6. **完成** → 返回voice_id，可用于语音合成

## 🔍 验证配置

### 检查服务器配置

1. **环境变量**（.env文件）：
```bash
DASHSCOPE_API_KEY=sk-67f551815ab14c35afc14170be7dacca
SERVER_DOMAIN=https://hongkong.xingke888.com
```

2. **测试media文件访问**：
```bash
# 创建测试文件
echo "test" > /var/www/harry-insurance2/media/test.txt

# 本地测试
curl -I http://localhost:8017/media/test.txt

# 公网测试
curl -I https://hongkong.xingke888.com/media/test.txt

# 应该返回 200 OK
```

## 🚨 常见问题

### 1. "创建音色失败: InvalidURL"

**可能原因：**
- 服务器域名配置错误
- 文件无法公网访问
- Nginx配置问题

**解决步骤：**
```bash
# 1. 检查环境变量
grep SERVER_DOMAIN /var/www/harry-insurance2/.env

# 2. 测试文件是否可公网访问
curl -I https://hongkong.xingke888.com/media/personal_voices/[voice-id]/voice_sample.wav

# 3. 检查Django日志
tail -50 /tmp/django_tts.log
```

### 2. "音频格式转换失败"

**可能原因：**
- FFmpeg未安装
- 音频文件损坏

**解决步骤：**
```bash
# 检查FFmpeg
ffmpeg -version

# 测试音频文件
ffprobe /path/to/audio.wav
```

### 3. "音色创建超时"

**可能原因：**
- 阿里云服务响应慢
- 音频文件过大
- 网络问题

**解决方案：**
- 重试创建
- 使用较短的音频（10-30秒）
- 检查网络连接

### 4. "阿里云API Key无权限"

**可能原因：**
- API Key未开通cosyvoice-v3-plus服务
- 账户余额不足

**解决方案：**
- 登录 https://dashscope.console.aliyun.com/
- 检查服务开通状态
- 充值账户余额

## 📝 使用创建的个人语音

创建成功后，会获得一个 `voice_id`，使用它进行语音合成：

### 通过前端
1. 在"个人语音"标签中选择你创建的语音
2. 输入要合成的文本
3. 点击"合成语音"

### 通过API
```bash
curl -X POST https://hongkong.xingke888.com/api/personal-voice/synthesize/ \
  -H "Content-Type: application/json" \
  -d '{
    "text": "你好，这是我的专属声音",
    "voice_id": "cv123456-longxiaochun"
  }'
```

## 📞 技术支持

如果遇到问题：
1. 查看Django日志：`tail -100 /tmp/django_tts.log`
2. 检查Nginx日志：`sudo tail -100 /var/log/nginx/error.log`
3. 检查个人语音列表：`cat /var/www/harry-insurance2/media/personal_voices/voices.json`

## ✨ 下一步

系统已完全迁移到CosyVoice，您现在可以：
1. ✅ 使用预置语音进行标准TTS
2. ✅ 创建个人专属语音
3. ✅ 使用个人语音进行合成

所有功能均已测试验证，media文件可正常公网访问！
