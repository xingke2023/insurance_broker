# å¦‚ä½•æŸ¥çœ‹å¾®ä¿¡å¤´åƒå’Œæ˜µç§°

## å½“å‰çŠ¶æ€

âœ… **åŠŸèƒ½å·²å®ç°**ï¼š
- åç«¯æ”¯æŒå­˜å‚¨å’Œè¿”å›å¾®ä¿¡ç”¨æˆ·çš„æ˜µç§°å’Œå¤´åƒ
- å‰ç«¯ Dashboard é¡µé¢æ”¯æŒæ˜¾ç¤ºå¾®ä¿¡å¤´åƒå’Œæ˜µç§°
- å°ç¨‹åºç™»å½•é¡µé¢æ”¯æŒæ”¶é›†ç”¨æˆ·å¤´åƒå’Œæ˜µç§°

## ä¸ºä»€ä¹ˆç°åœ¨çœ‹ä¸åˆ°ï¼Ÿ

å› ä¸ºå½“å‰ç™»å½•çš„ç”¨æˆ·è´¦å·**æ²¡æœ‰å…³è”çš„å¾®ä¿¡ä¿¡æ¯**ï¼Œæˆ–è€…å¾®ä¿¡ä¿¡æ¯ä¸­çš„æ˜µç§°å’Œå¤´åƒä¸ºç©ºã€‚

## æµ‹è¯•æ–¹æ³•

### æ–¹æ³•1ï¼šä½¿ç”¨å·²æ·»åŠ å¾®ä¿¡ä¿¡æ¯çš„æµ‹è¯•è´¦å·

æˆ‘å·²ç»ä¸º `testuser` è´¦å·æ·»åŠ äº†æ¨¡æ‹Ÿçš„å¾®ä¿¡ä¿¡æ¯ï¼š
- **æ˜µç§°**ï¼šæµ‹è¯•ç”¨æˆ·
- **å¤´åƒ**ï¼šä¸€ä¸ªç¤ºä¾‹å¾®ä¿¡å¤´åƒURL

**æ“ä½œæ­¥éª¤**ï¼š
1. **é€€å‡ºå½“å‰ç™»å½•**
2. **ä½¿ç”¨ testuser è´¦å·é‡æ–°ç™»å½•**
   - ç”¨æˆ·åï¼š`testuser`
   - å¯†ç ï¼šä½ è®¾ç½®çš„å¯†ç 
3. **ç™»å½•æˆåŠŸåæŸ¥çœ‹ Dashboard**
   - å³ä¸Šè§’åº”è¯¥æ˜¾ç¤ºå¾®ä¿¡å¤´åƒï¼ˆåœ†å½¢ï¼‰
   - æ˜¾ç¤º"æµ‹è¯•ç”¨æˆ·"æ˜µç§°
   - æ¬¢è¿æ¶ˆæ¯ï¼š"æ¬¢è¿å›æ¥ï¼Œæµ‹è¯•ç”¨æˆ·ï¼"

### æ–¹æ³•2ï¼šåœ¨æµè§ˆå™¨ä¸­æ‰‹åŠ¨æ·»åŠ å¾®ä¿¡ä¿¡æ¯ï¼ˆç”¨äºæµ‹è¯•ï¼‰

å¦‚æœä½ æƒ³åœ¨å½“å‰è´¦å·ä¸Šæµ‹è¯•ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š

```javascript
// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
const user = JSON.parse(localStorage.getItem('user'));

// æ·»åŠ æ¨¡æ‹Ÿçš„å¾®ä¿¡ä¿¡æ¯
user.wechat = {
  nickname: 'æˆ‘çš„å¾®ä¿¡æ˜µç§°',
  avatar: 'https://thirdwx.qlogo.cn/mmopen/vi_32/POgEwh4mIHO4nibH0KlMECNjjGxQUq24ZEaGT4poC6icRiccVGKSyXwibcPq4BWmiaIGuG1icwxaQX6grC9VemZoJ8rg/132'
};

// ä¿å­˜å¹¶åˆ·æ–°
localStorage.setItem('user', JSON.stringify(user));
location.reload();
```

### æ–¹æ³•3ï¼šé€šè¿‡å¾®ä¿¡çœŸå®æˆæƒï¼ˆéœ€è¦é…ç½®ï¼‰

å¦‚æœä½ æƒ³ä½¿ç”¨çœŸå®çš„å¾®ä¿¡æˆæƒè·å–å¤´åƒå’Œæ˜µç§°ï¼Œéœ€è¦ï¼š

1. **é…ç½®å¾®ä¿¡å…¬ä¼—å·**ï¼ˆæœåŠ¡å·ï¼‰
2. **åœ¨åç«¯ settings.py ä¸­é…ç½®**ï¼š
```python
WECHAT_WEB_APP_ID = 'your_appid'
WECHAT_WEB_APP_SECRET = 'your_secret'
```
3. **åœ¨å¾®ä¿¡ä¸­æ‰“å¼€ H5 é¡µé¢**
4. **è§¦å‘å¾®ä¿¡æˆæƒæµç¨‹**

### æ–¹æ³•4ï¼šä½¿ç”¨å°ç¨‹åºï¼ˆæ¨èï¼‰

å°ç¨‹åºç«¯å·²ç»æ·»åŠ äº†è·å–ç”¨æˆ·ä¿¡æ¯çš„åŠŸèƒ½ï¼š

1. **åœ¨å°ç¨‹åºä¸­ç™»å½•**
2. **ç‚¹å‡»"å®Œå–„å¤´åƒä¿¡æ¯"æŒ‰é’®**
3. **é€‰æ‹©å¤´åƒ**
4. **è¾“å…¥æ˜µç§°**
5. **ç¡®è®¤æäº¤**
6. **è¿›å…¥ WebView æŸ¥çœ‹**

## æ˜¾ç¤ºæ•ˆæœè¯´æ˜

### æœ‰å¾®ä¿¡ä¿¡æ¯æ—¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä¸­å¿ƒ              ğŸ‘¤ æµ‹è¯•ç”¨æˆ· âŠ—é€€å‡ºâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘ æ˜¾ç¤ºå¾®ä¿¡å¤´åƒ    â†‘ æ˜¾ç¤ºå¾®ä¿¡æ˜µç§°

æ¬¢è¿å›æ¥ï¼Œæµ‹è¯•ç”¨æˆ·ï¼ â† ä½¿ç”¨å¾®ä¿¡æ˜µç§°
```

### æ²¡æœ‰å¾®ä¿¡ä¿¡æ¯æ—¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä¸­å¿ƒ              T  testuser âŠ—é€€å‡ºâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘ æ˜¾ç¤ºé¦–å­—æ¯å¤´åƒ  â†‘ æ˜¾ç¤ºç”¨æˆ·å

æ¬¢è¿å›æ¥ï¼Œtestuserï¼ â† ä½¿ç”¨ç”¨æˆ·å
```

## ä»£ç å®ç°ä½ç½®

### å‰ç«¯æ˜¾ç¤ºé€»è¾‘
æ–‡ä»¶ï¼š`/var/www/harry-insurance2/frontend/src/components/Dashboard.jsx`

**å¤´åƒæ˜¾ç¤º**ï¼ˆç¬¬248-264è¡Œï¼‰ï¼š
```jsx
{user?.wechat?.avatar ? (
  <img
    src={user.wechat.avatar}
    alt="avatar"
    className="h-8 w-8 sm:h-10 sm:w-10 rounded-full..."
    onError={(e) => {
      // å¤´åƒåŠ è½½å¤±è´¥æ—¶éšè—å›¾ç‰‡ï¼Œæ˜¾ç¤ºé»˜è®¤å¤´åƒ
      e.target.style.display = 'none';
      e.target.nextSibling.style.display = 'flex';
    }}
  />
) : null}

{/* é»˜è®¤å¤´åƒ */}
<div style={{display: user?.wechat?.avatar ? 'none' : 'flex'}}>
  {(user?.wechat?.nickname || user?.username)?.charAt(0).toUpperCase()}
</div>
```

**æ˜µç§°æ˜¾ç¤º**ï¼ˆç¬¬243-245è¡Œï¼‰ï¼š
```jsx
<p className="...">
  {user?.wechat?.nickname || user?.full_name}
</p>
```

**æ¬¢è¿æ¶ˆæ¯**ï¼ˆç¬¬280-282è¡Œï¼‰ï¼š
```jsx
<h2>
  æ¬¢è¿å›æ¥ï¼Œ{user?.wechat?.nickname || user?.full_name}ï¼
</h2>
```

### åç«¯æ¥å£
æ–‡ä»¶ï¼š`/var/www/harry-insurance2/api/auth_views.py`

**ç”¨æˆ·èµ„æ–™æ¥å£**ï¼ˆç¬¬195-222è¡Œï¼‰ï¼š
```python
@api_view(['GET', 'PUT'])
def user_profile(request):
    user_data = {
        'id': user.id,
        'username': user.username,
        # ...å…¶ä»–å­—æ®µ
    }

    # è¿”å›å¾®ä¿¡ä¿¡æ¯
    try:
        wechat_profile = user.wechat_profile
        user_data['wechat'] = {
            'nickname': wechat_profile.nickname,
            'avatar': wechat_profile.avatar_url,
        }
    except:
        pass

    return Response(user_data)
```

## æ•°æ®åº“ä¸­çš„å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯

å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š

```bash
cd /var/www/harry-insurance2
python manage.py shell

# æŸ¥çœ‹æ‰€æœ‰å¾®ä¿¡ç”¨æˆ·
from api.models import WeChatUser
for wx in WeChatUser.objects.all():
    print(f'ç”¨æˆ·: {wx.user.username}')
    print(f'æ˜µç§°: {wx.nickname}')
    print(f'å¤´åƒ: {wx.avatar_url}')
    print('---')
```

## ä¸ºå…¶ä»–ç”¨æˆ·æ·»åŠ å¾®ä¿¡ä¿¡æ¯

å¦‚æœä½ æƒ³ä¸ºå½“å‰ç™»å½•çš„ç”¨æˆ·æ·»åŠ å¾®ä¿¡ä¿¡æ¯ï¼Œå¯ä»¥æ‰§è¡Œï¼š

```bash
cd /var/www/harry-insurance2
python manage.py shell << 'EOF'
from django.contrib.auth.models import User
from api.models import WeChatUser

# æ›¿æ¢ä¸ºä½ çš„ç”¨æˆ·å
username = 'your_username'

user = User.objects.get(username=username)
wechat_user, created = WeChatUser.objects.get_or_create(
    user=user,
    defaults={
        'openid': f'test_openid_{username}',
        'nickname': 'æˆ‘çš„æ˜µç§°',
        'avatar_url': 'https://thirdwx.qlogo.cn/mmopen/vi_32/POgEwh4mIHO4nibH0KlMECNjjGxQUq24ZEaGT4poC6icRiccVGKSyXwibcPq4BWmiaIGuG1icwxaQX6grC9VemZoJ8rg/132'
    }
)

if not created:
    wechat_user.nickname = 'æˆ‘çš„æ˜µç§°'
    wechat_user.avatar_url = 'https://thirdwx.qlogo.cn/mmopen/vi_32/POgEwh4mIHO4nibH0KlMECNjjGxQUq24ZEaGT4poC6icRiccVGKSyXwibcPq4BWmiaIGuG1icwxaQX6grC9VemZoJ8rg/132'
    wechat_user.save()

print(f'âœ“ å·²ä¸ºç”¨æˆ· {username} æ·»åŠ å¾®ä¿¡ä¿¡æ¯')
EOF
```

## å¸¸è§é—®é¢˜

### Q1: é‡æ–°ç™»å½•åè¿˜æ˜¯çœ‹ä¸åˆ°ï¼Ÿ
**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. ç¡®è®¤ä½¿ç”¨çš„æ˜¯ `testuser` è´¦å·
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl+Shift+Delï¼‰
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
4. æ£€æŸ¥ localStorage ä¸­çš„ user å¯¹è±¡æ˜¯å¦åŒ…å« wechat å­—æ®µ

### Q2: å¤´åƒæ˜¾ç¤ºä¸å‡ºæ¥ï¼Ÿ
**A**:
- å¾®ä¿¡å¤´åƒURLå¯èƒ½éœ€è¦åœ¨å¾®ä¿¡ç¯å¢ƒä¸­è®¿é—®
- å¯ä»¥ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹å›¾ç‰‡è¯·æ±‚æ˜¯å¦æˆåŠŸ
- å¦‚æœå¤±è´¥ï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤ºé»˜è®¤å¤´åƒ

### Q3: å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå®å¾®ä¿¡æˆæƒï¼Ÿ
**A**:
1. ç”³è¯·å¹¶è®¤è¯å¾®ä¿¡æœåŠ¡å·
2. é…ç½®æˆæƒå›è°ƒåŸŸå
3. åœ¨ Django settings ä¸­é…ç½® APPID å’Œ SECRET
4. å®ç°å‰ç«¯æˆæƒè·³è½¬é€»è¾‘
5. ç”¨æˆ·æˆæƒåä¼šè‡ªåŠ¨è·å–çœŸå®çš„æ˜µç§°å’Œå¤´åƒ

## å°ç¨‹åºç«¯è·å–ç”¨æˆ·ä¿¡æ¯æµç¨‹

ç”±äºå¾®ä¿¡æ”¿ç­–è°ƒæ•´ï¼Œå°ç¨‹åºä¸èƒ½ç›´æ¥è·å–ç”¨æˆ·æ˜µç§°å’Œå¤´åƒï¼Œéœ€è¦ç”¨æˆ·ä¸»åŠ¨æˆæƒï¼š

1. **ç”¨æˆ·ç‚¹å‡»"å®Œå–„å¤´åƒä¿¡æ¯"æŒ‰é’®**
2. **é€‰æ‹©å¤´åƒ** - ä½¿ç”¨ `open-type="chooseAvatar"`
3. **è¾“å…¥æ˜µç§°** - ä½¿ç”¨ `type="nickname"` çš„input
4. **ç‚¹å‡»ç¡®è®¤** - ä¿å­˜åˆ°æœ¬åœ°å’ŒæœåŠ¡å™¨

## æ€»ç»“

åŠŸèƒ½å·²å®Œå…¨å®ç°ï¼åªéœ€è¦ï¼š
1. ä½¿ç”¨æœ‰å¾®ä¿¡ä¿¡æ¯çš„è´¦å·ç™»å½•ï¼ˆå¦‚ testuserï¼‰
2. æˆ–ä¸ºå½“å‰è´¦å·æ·»åŠ å¾®ä¿¡ä¿¡æ¯
3. é‡æ–°ç™»å½•å³å¯çœ‹åˆ°å¾®ä¿¡å¤´åƒå’Œæ˜µç§°æ˜¾ç¤º

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- `/var/www/harry-insurance2/å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºåŠŸèƒ½è¯´æ˜.md` - æŠ€æœ¯å®ç°è¯´æ˜
- æœ¬æ–‡æ¡£ - ä½¿ç”¨å’Œæµ‹è¯•è¯´æ˜
