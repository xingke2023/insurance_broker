# 微信小程序 WebView 退出登录功能说明

## 功能概述
实现了小程序 WebView 中打开的 H5 页面退出登录时，自动通知小程序并返回登录页的功能。

## 实现流程

### 1. 小程序端（已完成）

#### webview.wxml
```xml
<web-view src="{{webUrl}}" bindmessage="handleMessage"></web-view>
```

#### webview.js
```javascript
Page({
  // 接收 H5 页面的消息
  handleMessage(e) {
    console.log('收到H5页面消息:', e.detail.data)

    const messages = e.detail.data
    if (messages && messages.length > 0) {
      const lastMessage = messages[messages.length - 1]

      // 处理退出登录
      if (lastMessage.action === 'logout') {
        this.handleLogout()
      }
    }
  },

  // 退出登录
  handleLogout() {
    wx.showModal({
      title: '提示',
      content: '确定要退出登录吗？',
      success: (res) => {
        if (res.confirm) {
          // 清除本地存储
          wx.removeStorageSync('token')
          wx.removeStorageSync('userInfo')

          wx.showToast({
            title: '已退出登录',
            icon: 'success',
            duration: 1500
          })

          // 跳转到登录页
          setTimeout(() => {
            wx.reLaunch({
              url: '/pages/login/login'
            })
          }, 1500)
        }
      }
    })
  }
})
```

### 2. H5 端（已完成）

#### Dashboard.jsx
```javascript
// 检测是否在小程序环境中
const isInMiniProgram = () => {
  return typeof window !== 'undefined' &&
         typeof window.wx !== 'undefined' &&
         window.wx.miniProgram;
};

// 处理退出登录点击
const handleLogoutClick = () => {
  // 检测是否在小程序 WebView 中
  if (isInMiniProgram()) {
    // 在小程序中，发送消息给小程序
    window.wx.miniProgram.postMessage({
      data: {
        action: 'logout'
      }
    });

    // 返回小程序上一页，触发 postMessage
    window.wx.miniProgram.navigateBack();
  } else {
    // 在普通浏览器中，直接执行退出
    logout();
    onNavigate('home');
  }
};
```

## 工作原理

1. **用户点击退出按钮**
   - H5 页面检测是否在小程序环境中

2. **在小程序环境中**
   - 调用 `wx.miniProgram.postMessage()` 发送退出消息
   - 调用 `wx.miniProgram.navigateBack()` 返回上一页
   - `navigateBack` 会触发 `postMessage` 的消息发送

3. **小程序接收消息**
   - `webview.wxml` 的 `bindmessage` 触发
   - `handleMessage` 方法接收到消息
   - 判断 `action === 'logout'`
   - 调用 `handleLogout()` 处理退出逻辑

4. **退出登录处理**
   - 弹出确认对话框
   - 清除本地存储的 token 和 userInfo
   - 跳转到登录页

5. **在普通浏览器中**
   - 直接执行 H5 的退出逻辑
   - 不发送小程序消息

## 技术要点

### postMessage 触发时机
`postMessage` 的消息会在以下时机触发：
- 小程序后退时
- 组件销毁时
- 分享时

因此需要在发送 `postMessage` 后立即调用 `navigateBack()` 来触发消息发送。

### 消息格式
```javascript
{
  data: {
    action: 'logout'  // 自定义的动作标识
  }
}
```

### 环境检测
```javascript
typeof window !== 'undefined' &&
typeof window.wx !== 'undefined' &&
window.wx.miniProgram
```

## 测试步骤

1. 在小程序中打开 WebView 页面
2. 进入 Dashboard 页面
3. 点击右上角的"退出"按钮
4. 应该看到：
   - 页面返回到小程序
   - 小程序弹出退出确认对话框
   - 确认后清除登录信息
   - 跳转到登录页

## 注意事项

1. 必须在微信小程序的开发者工具或真机中测试
2. H5 页面必须通过小程序的 web-view 组件打开
3. 需要配置业务域名白名单
4. `postMessage` 只能在特定时机触发，不是实时的

## 相关文件

- `/wechat/pages/webview/webview.js` - 小程序 WebView 页面逻辑
- `/wechat/pages/webview/webview.wxml` - 小程序 WebView 页面模板
- `/wechat/pages/webview/webview.json` - 小程序 WebView 页面配置
- `/frontend/src/components/Dashboard.jsx` - H5 Dashboard 页面
- `/frontend/index.html` - 引入微信 JSSDK

## 扩展功能

可以通过相同的方式实现其他小程序与 H5 的通信功能：

```javascript
// H5 发送消息
wx.miniProgram.postMessage({
  data: {
    action: 'share',        // 分享
    action: 'navigate',     // 导航
    action: 'refresh',      // 刷新
    // ... 更多自定义动作
  }
});

// 小程序接收处理
handleMessage(e) {
  const lastMessage = messages[messages.length - 1]

  switch(lastMessage.action) {
    case 'logout':
      this.handleLogout()
      break
    case 'share':
      this.handleShare()
      break
    // ... 更多处理
  }
}
```
