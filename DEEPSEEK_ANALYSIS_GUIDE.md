# DeepSeek AI å¹´åº¦ä»·å€¼è¡¨åˆ†æåŠŸèƒ½æŒ‡å—

## åŠŸèƒ½æ¦‚è¿°

ç‚¹å‡»ä¿å­˜æŒ‰é’®åï¼Œç³»ç»Ÿä¼šï¼š
1. **ç«‹å³ä¿å­˜** OCRè¯†åˆ«å†…å®¹åˆ°æ•°æ®åº“
2. **å¼‚æ­¥è°ƒç”¨** DeepSeekå¤§æ¨¡å‹åˆ†æå¹´åº¦ä»·å€¼è¡¨
3. **è‡ªåŠ¨æ›´æ–°** åˆ†æç»“æœåˆ°æ•°æ®åº“çš„ `table` å­—æ®µ

## å·¥ä½œæµç¨‹

```
ç”¨æˆ·ç‚¹å‡»ä¿å­˜
    â†“
ä¿å­˜OCRå†…å®¹åˆ°æ•°æ®åº“ (ç«‹å³å®Œæˆ)
    â†“
è¿”å›æˆåŠŸå“åº”ç»™å‰ç«¯
    â†“
åå°å¼‚æ­¥è°ƒç”¨DeepSeek API (åœ¨çº¿ç¨‹ä¸­è¿è¡Œ)
    â†“
åˆ†ææå–å¹´åº¦ä»·å€¼è¡¨æ•°æ®
    â†“
æ›´æ–°æ•°æ®åº“çš„tableå­—æ®µ
```

## æå–çš„æ•°æ®å­—æ®µ

| å­—æ®µå | è¯´æ˜ | ç±»å‹ |
|--------|------|------|
| `policy_year` | ä¿å–®å¹´åº¦çµ‚çµ | æ•´æ•° |
| `guaranteed_cash_value` | ä¿è­‰ç¾é‡‘åƒ¹å€¼(A) | æ•°å­—(ä¸¤ä½å°æ•°) |
| `terminal_bonus` | çµ‚æœŸç´…åˆ©(B) | æ•°å­—(ä¸¤ä½å°æ•°) |
| `total` | æ€»é¢ (A)+(B) | æ•°å­—(ä¸¤ä½å°æ•°) |

## æ•°æ®æ ¼å¼

### æ•°æ®åº“å­˜å‚¨æ ¼å¼ (JSON)

```json
{
  "years": [
    {
      "policy_year": 1,
      "guaranteed_cash_value": 5000.00,
      "terminal_bonus": 1000.00,
      "total": 6000.00
    },
    {
      "policy_year": 2,
      "guaranteed_cash_value": 10500.00,
      "terminal_bonus": 2200.00,
      "total": 12700.00
    },
    {
      "policy_year": 3,
      "guaranteed_cash_value": 16200.00,
      "terminal_bonus": 3500.00,
      "total": 19700.00
    }
  ]
}
```

## ä½¿ç”¨æ­¥éª¤

### 1. è§£ææ–‡æ¡£

- è®¿é—®"ä¿å•æ™ºèƒ½åˆ†æç³»ç»Ÿ"
- ä¸Šä¼ PDF/å›¾ç‰‡æ–‡æ¡£
- ç‚¹å‡»"å¼€å§‹åˆ†æ"
- ç­‰å¾…OCRè§£æå®Œæˆ

### 2. ä¿å­˜ç»“æœ

- ç‚¹å‡»"ğŸ’¾ ä¿å­˜åˆ°æ•°æ®åº“"æŒ‰é’®
- ç³»ç»Ÿç«‹å³ä¿å­˜OCRå†…å®¹
- æ˜¾ç¤º"ä¿å­˜æˆåŠŸ"æç¤º

### 3. ç­‰å¾…åˆ†æ

- DeepSeekåœ¨åå°è‡ªåŠ¨åˆ†æï¼ˆå¼‚æ­¥è¿›è¡Œï¼‰
- ä¸éœ€è¦ç”¨æˆ·ç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­å…¶ä»–æ“ä½œ
- åˆ†æé€šå¸¸éœ€è¦ 5-30 ç§’

### 4. æŸ¥çœ‹ç»“æœ

- è¿›å…¥"è®¡åˆ’ä¹¦ç®¡ç†"
- ç‚¹å‡»å·²ä¿å­˜çš„æ–‡æ¡£
- æŸ¥çœ‹è¯¦æƒ…é¡µé¢
- å¦‚æœåˆ†æå®Œæˆï¼Œä¼šæ˜¾ç¤º"å¹´åº¦ä»·å€¼è¡¨"éƒ¨åˆ†

## ç•Œé¢å±•ç¤º

### è¯¦æƒ…é¡µ - å¹´åº¦ä»·å€¼è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¹´åº¦ä»·å€¼è¡¨                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¿å–®å¹´åº¦çµ‚çµ â”‚ ä¿è­‰ç¾é‡‘åƒ¹å€¼(A) â”‚ çµ‚æœŸç´…åˆ©(B) â”‚ æ€»é¢ (A)+(B)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¬¬ 1 å¹´      â”‚      5,000.00   â”‚   1,000.00  â”‚    6,000.00  â”‚
â”‚ ç¬¬ 2 å¹´      â”‚     10,500.00   â”‚   2,200.00  â”‚   12,700.00  â”‚
â”‚ ç¬¬ 3 å¹´      â”‚     16,200.00   â”‚   3,500.00  â”‚   19,700.00  â”‚
â”‚ ç¬¬ 5 å¹´      â”‚     28,500.00   â”‚   6,000.00  â”‚   34,500.00  â”‚
â”‚ ç¬¬ 10 å¹´     â”‚     62,000.00   â”‚  13,000.00  â”‚   75,000.00  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- æ•°å­—è‡ªåŠ¨åƒåˆ†ä½æ ¼å¼åŒ–
- æ€»é¢ç”¨è“è‰²é«˜äº®æ˜¾ç¤º
- è¡¨æ ¼å¯æ‚¬åœé«˜äº®
- ç¾è§‚çš„è¾¹æ¡†å’Œé—´è·

## æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“æ¨¡å‹

**æ–‡ä»¶**: `/var/www/harry-insurance/api/models.py`

```python
class PlanDocument(models.Model):
    # ... å…¶ä»–å­—æ®µ

    # AIåˆ†æçš„å¹´åº¦ä»·å€¼è¡¨æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
    table = models.JSONField(verbose_name='å¹´åº¦ä»·å€¼è¡¨', default=dict, blank=True, null=True)
```

### 2. DeepSeek åˆ†ææœåŠ¡

**æ–‡ä»¶**: `/var/www/harry-insurance/api/deepseek_service.py`

**æ ¸å¿ƒå‡½æ•°**:
```python
def analyze_insurance_table(ocr_content):
    """åˆ†æä¿é™©è®¡åˆ’ä¹¦å†…å®¹ï¼Œæå–å¹´åº¦ä»·å€¼è¡¨æ•°æ®"""
    # è°ƒç”¨DeepSeek API
    # è¿”å›JSONæ ¼å¼çš„å¹´åº¦æ•°æ®
```

**é…ç½®**:
- APIåœ°å€: `https://api.deepseek.com`
- æ¨¡å‹: `deepseek-chat`
- Temperature: 0.1 (æé«˜å‡†ç¡®æ€§)
- Max Tokens: 4000

### 3. å¼‚æ­¥ä¿å­˜é€»è¾‘

**æ–‡ä»¶**: `/var/www/harry-insurance/api/ocr_views.py`

```python
# 1. å…ˆä¿å­˜OCRå†…å®¹
plan_doc.save()

# 2. å¯åŠ¨å¼‚æ­¥çº¿ç¨‹åˆ†æ
def async_analyze_table():
    table_data = analyze_insurance_table(ocr_content)
    if table_data:
        doc = PlanDocument.objects.get(id=plan_doc.id)
        doc.table = table_data
        doc.save()

analysis_thread = threading.Thread(target=async_analyze_table)
analysis_thread.daemon = True
analysis_thread.start()

# 3. ç«‹å³è¿”å›æˆåŠŸå“åº”
return Response({'status': 'success', ...})
```

### 4. å‰ç«¯æ˜¾ç¤º

**æ–‡ä»¶**: `/var/www/harry-insurance/frontend/src/components/PlanDocumentManagement.jsx`

- æ¡ä»¶æ¸²æŸ“ï¼šåªåœ¨æœ‰tableæ•°æ®æ—¶æ˜¾ç¤º
- è¡¨æ ¼å¸ƒå±€ï¼šä½¿ç”¨Tailwind CSSæ ·å¼
- æ•°æ®æ ¼å¼åŒ–ï¼šåƒåˆ†ä½æ˜¾ç¤ºï¼Œä¿ç•™ä¸¤ä½å°æ•°

## ç¯å¢ƒå˜é‡é…ç½®

### DeepSeek APIå¯†é’¥

```bash
# åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®
DEEPSEEK_API_KEY=sk-your-api-key-here
```

**è·å–APIå¯†é’¥**:
1. è®¿é—® https://platform.deepseek.com/
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. åˆ›å»ºAPIå¯†é’¥
4. å¤åˆ¶å¯†é’¥åˆ°ç¯å¢ƒå˜é‡

### å¦‚æœæ²¡æœ‰é…ç½®APIå¯†é’¥

ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨**æ¨¡æ‹Ÿæ•°æ®**è¿›è¡Œæµ‹è¯•ï¼š
```python
def mock_analyze_insurance_table(ocr_content):
    """è¿”å›æ¨¡æ‹Ÿçš„å¹´åº¦ä»·å€¼è¡¨æ•°æ®"""
    return {
        "years": [
            {"policy_year": 1, "guaranteed_cash_value": 5000.00, ...},
            {"policy_year": 2, "guaranteed_cash_value": 10500.00, ...},
            ...
        ]
    }
```

## API æ¥å£

### ä¿å­˜å¹¶åˆ†æ

**ç«¯ç‚¹**: `POST /api/ocr/save/`

**è¯·æ±‚ä½“**:
```json
{
  "file_name": "document.pdf",
  "ocr_content": "è¯†åˆ«çš„æ–‡æœ¬å†…å®¹...",
  "task_id": "task_123",
  "result_dir": "/path/to/result",
  "user_id": 1
}
```

**å“åº”**:
```json
{
  "status": "success",
  "message": "ä¿å­˜æˆåŠŸ",
  "document_id": 123,
  "data": {
    "id": 123,
    "file_name": "document.pdf",
    "status": "completed",
    "created_at": "2025-11-05T21:00:00",
    "content_length": 1234
  }
}
```

**è¯´æ˜**:
- å“åº”ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…DeepSeekåˆ†æå®Œæˆ
- åˆ†æåœ¨åå°å¼‚æ­¥è¿›è¡Œ
- åˆ†æå®Œæˆåè‡ªåŠ¨æ›´æ–°æ•°æ®åº“

### è·å–æ–‡æ¡£è¯¦æƒ…ï¼ˆå«å¹´åº¦ä»·å€¼è¡¨ï¼‰

**ç«¯ç‚¹**: `GET /api/ocr/documents/<id>/`

**å“åº”**:
```json
{
  "status": "success",
  "data": {
    "id": 123,
    "file_name": "document.pdf",
    "content": "OCRè¯†åˆ«å†…å®¹...",
    "table": {
      "years": [
        {
          "policy_year": 1,
          "guaranteed_cash_value": 5000.00,
          "terminal_bonus": 1000.00,
          "total": 6000.00
        }
      ]
    },
    "created_at": "2025-11-05T21:00:00",
    "updated_at": "2025-11-05T21:00:30"
  }
}
```

## æ—¥å¿—æŸ¥çœ‹

### æŸ¥çœ‹åç«¯æ—¥å¿—

```bash
# æŸ¥çœ‹Djangoæ—¥å¿—
tail -f /tmp/django_backend.log

# æŸ¥çœ‹åˆ†ææ—¥å¿—
python3 manage.py shell
>>> import logging
>>> logging.basicConfig(level=logging.INFO)
```

### å…³é”®æ—¥å¿—ä¿¡æ¯

```
INFO: å¼€å§‹å¼‚æ­¥åˆ†ææ–‡æ¡£ 123 çš„å¹´åº¦ä»·å€¼è¡¨
INFO: å¼€å§‹è°ƒç”¨ DeepSeek API åˆ†æå¹´åº¦ä»·å€¼è¡¨
INFO: DeepSeek API è¿”å›å†…å®¹: {"years": [...]}
INFO: æˆåŠŸè§£æå¹´åº¦ä»·å€¼è¡¨ï¼Œå…± 5 æ¡è®°å½•
INFO: æ–‡æ¡£ 123 çš„å¹´åº¦ä»·å€¼è¡¨åˆ†æå®Œæˆï¼Œå…± 5 æ¡è®°å½•
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: å¹´åº¦ä»·å€¼è¡¨ä¸æ˜¾ç¤º

**å¯èƒ½åŸå› **:
1. DeepSeekåˆ†æè¿˜åœ¨è¿›è¡Œä¸­ï¼ˆç­‰å¾…å‡ ç§’åˆ·æ–°ï¼‰
2. APIå¯†é’¥æœªé…ç½®æˆ–é”™è¯¯
3. OCRå†…å®¹ä¸­æ²¡æœ‰å¹´åº¦ä»·å€¼è¡¨æ•°æ®
4. DeepSeekè¿”å›æ ¼å¼é”™è¯¯

**è§£å†³æ–¹æ³•**:
```bash
# 1. æ£€æŸ¥æ–‡æ¡£çš„tableå­—æ®µ
python3 manage.py shell
>>> from api.models import PlanDocument
>>> doc = PlanDocument.objects.get(id=123)
>>> print(doc.table)

# 2. æŸ¥çœ‹åç«¯æ—¥å¿—
tail -f /tmp/django_backend.log

# 3. æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $DEEPSEEK_API_KEY
```

### é—®é¢˜2: DeepSeek API è°ƒç”¨å¤±è´¥

**é”™è¯¯æ—¥å¿—**:
```
ERROR: DeepSeek API è°ƒç”¨å¤±è´¥: API key is invalid
```

**è§£å†³**:
1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤APIå¯†é’¥æœ‰è¶³å¤Ÿçš„é…é¢
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

### é—®é¢˜3: JSONè§£æå¤±è´¥

**é”™è¯¯æ—¥å¿—**:
```
ERROR: è§£æ DeepSeek è¿”å›çš„JSONå¤±è´¥: Expecting value: line 1 column 1 (char 0)
```

**è§£å†³**:
- DeepSeekå¯èƒ½è¿”å›äº†éJSONæ ¼å¼
- æŸ¥çœ‹åŸå§‹è¿”å›å†…å®¹
- è°ƒæ•´promptè®©DeepSeekåªè¿”å›JSON

### é—®é¢˜4: å¼‚æ­¥çº¿ç¨‹æœªæ‰§è¡Œ

**æ£€æŸ¥**:
```python
# ç¡®è®¤çº¿ç¨‹å·²å¯åŠ¨
import threading
print(threading.active_count())  # åº”è¯¥ > 1
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¤„ç†ä¼˜åŠ¿

- âœ… ç”¨æˆ·ä¸éœ€è¦ç­‰å¾…åˆ†æå®Œæˆ
- âœ… å‰ç«¯ç«‹å³å¾—åˆ°å“åº”
- âœ… åå°å¹¶è¡Œå¤„ç†å¤šä¸ªæ–‡æ¡£

### 2. åˆ†ææ—¶é—´

- OCRå†…å®¹ < 1000å­—ï¼šçº¦ 5-10ç§’
- OCRå†…å®¹ 1000-5000å­—ï¼šçº¦ 10-20ç§’
- OCRå†…å®¹ > 5000å­—ï¼šçº¦ 20-30ç§’

### 3. å¹¶å‘å¤„ç†

- ä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªæ–‡æ¡£
- å½“å‰ä½¿ç”¨ `daemon=True` é¿å…é˜»å¡ä¸»è¿›ç¨‹

## æœªæ¥æ‰©å±•

### å¯ä»¥æ·»åŠ çš„åŠŸèƒ½

- [ ] æ·»åŠ åˆ†æçŠ¶æ€å­—æ®µï¼ˆanalyzing/analyzed/failedï¼‰
- [ ] å®ç°WebSocketå®æ—¶æ¨é€åˆ†æç»“æœ
- [ ] æ”¯æŒé‡æ–°åˆ†æåŠŸèƒ½
- [ ] æ‰¹é‡åˆ†æå¤šä¸ªæ–‡æ¡£
- [ ] åˆ†æè¿›åº¦æ˜¾ç¤º
- [ ] åˆ†æå†å²è®°å½•
- [ ] å¯¼å‡ºå¹´åº¦ä»·å€¼è¡¨ä¸ºExcel
- [ ] å¹´åº¦ä»·å€¼è¡¨å¯è§†åŒ–å›¾è¡¨

## ç›¸å…³æ–‡ä»¶

- **æ•°æ®æ¨¡å‹**: `/var/www/harry-insurance/api/models.py`
- **åˆ†ææœåŠ¡**: `/var/www/harry-insurance/api/deepseek_service.py`
- **ä¿å­˜API**: `/var/www/harry-insurance/api/ocr_views.py`
- **å‰ç«¯ç»„ä»¶**: `/var/www/harry-insurance/frontend/src/components/PlanDocumentManagement.jsx`
- **æ•°æ®åº“è¿ç§»**: `/var/www/harry-insurance/api/migrations/0003_plandocument_content_plandocument_table.py`

## æ›´æ–°æ—¥å¿—

### 2025-11-05

âœ… **æ–°åŠŸèƒ½**:
1. æ·»åŠ  `table` JSONField åˆ° PlanDocument æ¨¡å‹
2. åˆ›å»º DeepSeek åˆ†ææœåŠ¡
3. å®ç°å¼‚æ­¥åˆ†æå¹´åº¦ä»·å€¼è¡¨
4. å‰ç«¯æ˜¾ç¤ºå¹´åº¦ä»·å€¼è¡¨
5. æ”¯æŒæ¨¡æ‹Ÿæ•°æ®æµ‹è¯•ï¼ˆæ— APIå¯†é’¥æ—¶ï¼‰
6. è¯¦ç»†çš„æ—¥å¿—è®°å½•
7. ç¼–å†™å®Œæ•´ä½¿ç”¨æ–‡æ¡£

---

**æç¤º**: ç°åœ¨ä¿å­˜OCRç»“æœæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†æå¹¶æå–å¹´åº¦ä»·å€¼è¡¨æ•°æ®ï¼
