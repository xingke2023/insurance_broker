# 计划书管理 - 用户使用指南

## 功能概述

计划书管理是一个用户前台功能，允许用户查看、搜索和管理所有已保存的保险计划书文档。

## 访问方式

### 1. 从首页进入

1. 访问系统首页: http://localhost:8011
2. 找到 **计划书管理** 工具卡片
3. 点击 **立即使用** 按钮

### 2. 直接访问

系统会自动路由到计划书管理页面（内部路由：`plan-management`）

## 主要功能

### ✅ 计划书列表

**显示内容**：
- 文件图标和状态标签
- 文件名
- 创建时间
- 查看详情按钮

**功能特性**：
- 📊 显示计划书总数
- 🔍 实时搜索（按文件名）
- 🗂️ 状态筛选（全部/已上传/处理中/已完成/失败）
- 📱 响应式网格布局（自适应）

### ✅ 搜索功能

**位置**：列表页面顶部

**使用方法**：
1. 在搜索框输入文件名关键词
2. 系统自动实时筛选
3. 支持模糊搜索

### ✅ 状态筛选

**位置**：搜索框右侧

**状态类型**：
- 🔵 已上传 (uploaded)
- 🟡 处理中 (processing)
- 🟢 已完成 (completed)
- 🔴 失败 (failed)

### ✅ 查看详情

**进入方式**：
- 点击卡片
- 点击"查看详情"按钮

**详情页显示**：

#### 1. 文档基本信息
- 文件名（大标题）
- 创建时间
- 状态标签

#### 2. 保险信息卡片
- 👤 受保人姓名
- 🏢 保险公司

#### 3. OCR识别内容
- 完整的文本内容
- 格式化显示（保留换行）
- 可滚动查看（最大高度600px）
- 浅灰背景，便于阅读

#### 4. 提取数据
- JSON格式显示
- 包含task_id、result_dir等元数据

## 界面预览

### 列表页面

```
┌─────────────────────────────────────────────────────────────┐
│  ← 返回首页                                                  │
│                                                             │
│  计划书管理                                    9 份计划书    │
│  查看和管理您的保险计划书文档                                │
├─────────────────────────────────────────────────────────────┤
│  🔍 搜索文件名...                    [状态筛选 ▼]            │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│  │ 📄 文档1    │  │ 📄 文档2    │  │ 📄 文档3    │           │
│  │            │  │            │  │            │           │
│  │ 🟢 已完成   │  │ 🟢 已完成   │  │ 🟢 已完成   │           │
│  │ 2025-11-05 │  │ 2025-11-05 │  │ 2025-11-04 │           │
│  │            │  │            │  │            │           │
│  │ [👁️ 查看详情]│  │ [👁️ 查看详情]│  │ [👁️ 查看详情]│           │
│  └────────────┘  └────────────┘  └────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

### 详情页面

```
┌─────────────────────────────────────────────────────────────┐
│  ← 返回列表                                                  │
│                                                             │
│  document.pdf                                               │
│  📅 创建时间: 2025-11-05 20:30:00    🟢 已完成               │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐                        │
│  │ 👤 受保人     │  │ 🏢 保险公司   │                        │
│  │ 张三         │  │ XX保险公司   │                        │
│  └──────────────┘  └──────────────┘                        │
├─────────────────────────────────────────────────────────────┤
│  识别内容                                                    │
│  ┌───────────────────────────────────────────────────────┐ │
│  │ COMPLETED                                             │ │
│  │                                                       │ │
│  │ MODELCHAT POSITIONS                                   │ │
│  │ ...                                                   │ │
│  │                                                       │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 使用场景

### 场景1：查看所有计划书

1. 从首页点击"计划书管理"
2. 查看所有已保存的计划书列表
3. 可以看到每份文档的状态和创建时间

### 场景2：搜索特定计划书

1. 进入计划书管理
2. 在搜索框输入文件名关键词（如："张三"）
3. 系统实时显示匹配的文档

### 场景3：筛选已完成的文档

1. 点击状态筛选下拉框
2. 选择"已完成"
3. 只显示状态为已完成的文档

### 场景4：查看OCR内容

1. 点击任意计划书卡片
2. 进入详情页
3. 滚动查看完整的OCR识别内容
4. 可以复制文本内容

### 场景5：从详情返回列表

1. 在详情页点击"← 返回列表"
2. 返回到计划书列表页面
3. 保持之前的搜索和筛选状态（如有）

## 数据流程

### 保存计划书

```
保单智能分析系统 → 解析文档 → 点击保存 → 保存到数据库
                                           ↓
                                    plan_documents表
```

### 查看计划书

```
首页 → 计划书管理 → 列表页 → 详情页
                    ↓
              GET /api/ocr/documents/
                    ↓
              显示所有文档
```

## API 接口

### 1. 获取文档列表

**端点**: `GET /api/ocr/documents/`

**响应**:
```json
{
  "status": "success",
  "count": 9,
  "data": [
    {
      "id": 10,
      "file_name": "document.pdf",
      "status": "completed",
      "created_at": "2025-11-05T20:30:00",
      "content_length": 1234
    }
  ]
}
```

### 2. 获取文档详情

**端点**: `GET /api/ocr/documents/<id>/`

**响应**:
```json
{
  "status": "success",
  "data": {
    "id": 10,
    "file_name": "document.pdf",
    "file_size": 1234,
    "status": "completed",
    "content": "完整的OCR识别内容...",
    "insured_name": "张三",
    "insurance_company": "XX保险公司",
    "insurance_product": "终身寿险",
    "extracted_data": {
      "task_id": "task_123",
      "result_dir": "/path/to/result"
    },
    "created_at": "2025-11-05T20:30:00",
    "updated_at": "2025-11-05T20:30:00"
  }
}
```

## 技术实现

### 前端组件

**文件**: `/var/www/harry-insurance/frontend/src/components/PlanDocumentManagement.jsx`

**主要功能**：
- 列表展示和加载状态
- 实时搜索和筛选
- 详情页切换
- 响应式布局

**状态管理**：
```javascript
const [documents, setDocuments] = useState([]);      // 文档列表
const [loading, setLoading] = useState(true);        // 加载状态
const [selectedDoc, setSelectedDoc] = useState(null); // 选中的文档
const [searchTerm, setSearchTerm] = useState('');    // 搜索词
const [filterStatus, setFilterStatus] = useState('all'); // 筛选状态
```

### 后端API

**文件**: `/var/www/harry-insurance/api/ocr_views.py`

**关键修改**：
- 详情API返回 `content` 字段（完整OCR内容）
- 返回 `insured_name`、`insurance_company` 等保险信息

### 路由配置

**文件**: `/var/www/harry-insurance/frontend/src/App.jsx`

```javascript
{currentPage === 'plan-management' && <PlanDocumentManagement onNavigate={setCurrentPage} />}
```

## 样式设计

### 配色方案

- **主色调**: Teal（青绿色）
- **状态颜色**:
  - 🔵 蓝色 - 已上传
  - 🟡 黄色 - 处理中
  - 🟢 绿色 - 已完成
  - 🔴 红色 - 失败

### 布局特点

- 渐变背景（蓝-靛-紫）
- 圆角卡片设计
- 悬停动画效果
- 响应式网格布局

## 用户体验

### 优点

✅ **简洁直观**: 清晰的卡片式布局
✅ **搜索便捷**: 实时搜索，无需点击按钮
✅ **状态明确**: 彩色标签区分不同状态
✅ **内容完整**: 详情页显示所有OCR内容
✅ **响应式**: 适配不同屏幕尺寸

### 加载状态

- 加载时显示旋转动画
- 空状态显示友好提示

### 错误处理

- 网络错误自动捕获
- Console输出详细错误信息

## 与其他功能的关联

### 1. 保单智能分析系统

- 用户在分析系统解析文档后点击保存
- 保存的文档会出现在计划书管理中

### 2. 用户认证

- 使用 `useAuth()` 获取当前登录用户
- 保存文档时关联用户ID（如已登录）

### 3. 首页导航

- 首页新增"计划书管理"工具卡片
- 点击进入管理页面

## 数据统计

在列表页右上角显示：
```
9 份计划书
```

## 权限说明

- 所有登录用户可以查看所有计划书（暂无权限限制）
- 未来可以添加：
  - 只显示当前用户上传的文档
  - 管理员可以查看所有文档

## 未来扩展

### 可以添加的功能

- [ ] 删除文档
- [ ] 下载原文件
- [ ] 编辑保险信息字段
- [ ] 导出为PDF/Excel
- [ ] 分享链接
- [ ] 添加备注
- [ ] 标签管理
- [ ] 批量操作
- [ ] 权限控制（只看自己的文档）
- [ ] 文档对比功能

## 相关文件

- **前端组件**: `/var/www/harry-insurance/frontend/src/components/PlanDocumentManagement.jsx`
- **后端API**: `/var/www/harry-insurance/api/ocr_views.py`
- **路由配置**: `/var/www/harry-insurance/frontend/src/App.jsx`
- **首页集成**: `/var/www/harry-insurance/frontend/src/components/HomePage.jsx`
- **数据模型**: `/var/www/harry-insurance/api/models.py`

## 测试步骤

### 1. 准备数据

确保数据库中有计划书数据（通过保单智能分析系统保存）

### 2. 访问列表

```bash
# 确保服务运行
# 后端: http://localhost:8007
# 前端: http://localhost:8011

# 访问首页
http://localhost:8011

# 点击"计划书管理"
```

### 3. 测试搜索

- 输入文件名关键词
- 验证实时搜索效果

### 4. 测试筛选

- 选择不同状态
- 验证筛选结果

### 5. 测试详情

- 点击任意文档
- 验证详情页显示
- 检查OCR内容是否完整

### 6. 测试返回

- 点击"返回列表"
- 验证返回功能

## 故障排查

### 问题1: 列表为空

**原因**: 数据库中没有数据

**解决**:
1. 使用保单智能分析系统解析并保存文档
2. 或使用Django shell创建测试数据

### 问题2: 详情页无内容

**原因**: content字段为空

**解决**:
1. 检查保存API是否正确保存content
2. 查看extracted_data中是否有ocr_content

### 问题3: API请求失败

**原因**:
- 后端未启动
- 代理配置问题
- CORS错误

**解决**:
```bash
# 检查后端
ps aux | grep "manage.py runserver"

# 检查Vite代理配置
cat frontend/vite.config.js
```

### 问题4: 搜索不工作

**原因**: JavaScript错误

**解决**:
- 打开浏览器控制台查看错误
- 检查搜索逻辑实现

## 更新日志

### 2025-11-05

✅ **新功能**:
1. 创建计划书管理前台页面
2. 实现列表展示功能
3. 实现搜索和筛选功能
4. 实现详情查看功能
5. 集成到首页导航
6. 修改API返回content字段
7. 添加保险信息显示
8. 编写完整使用文档

---

**提示**: 现在可以通过首页的"计划书管理"工具访问和管理所有保险计划书！
