# Django Admin 页面权限管理指南

## 🎯 功能概述

系统现在支持通过 Django Admin 后台灵活配置页面访问权限。您可以：

- ✅ 创建新的页面权限配置
- ✅ 指定哪些用户组可以访问特定页面
- ✅ 设置是否需要管理员权限
- ✅ 启用或禁用权限控制
- ✅ 调整页面在前端的显示顺序

## 📍 访问管理后台

### 1. 登录 Django Admin
```
URL: http://your-domain:8007/admin/
用户名: 您的管理员账号
密码: 您的管理员密码
```

### 2. 进入页面权限管理
导航至：**API** → **页面访问权限**（Page permissions）

或直接访问：`http://your-domain:8007/admin/api/pagepermission/`

## 🛠️ 管理页面权限

### 查看现有权限配置

在列表页面可以看到：
- **页面名称**：如"计划书分步骤分析"
- **页面代码**：唯一标识符（plan-analyzer-2）
- **访问权限**：
  - 🔒 仅管理员：只有 is_staff=True 的用户可访问
  - 👥 用户组名称：指定用户组的成员可访问
  - 🌍 所有用户：所有登录用户都可访问
- **启用状态**：权限控制是否生效
- **排序**：页面在前端的显示顺序

### 创建新的页面权限

点击右上角**增加页面访问权限**按钮：

#### 1. 页面信息（必填）
```
页面名称：用户看到的显示名称（如：计划书管理）
页面代码：唯一标识，对应前端路由（如：plan-management）
路由路径：完整路由（如：/plan-management）
描述：功能说明（可选）
```

#### 2. 显示设置（可选）
```
图标：页面图标类名（如：FolderIcon）
颜色：渐变色类名（如：from-blue-600 to-indigo-600）
```

#### 3. 权限配置（核心）
```
允许的用户组：
  - 选择一个或多个用户组
  - 如果不选择任何组 → 所有登录用户都可访问
  - 使用横向选择器轻松管理

需要管理员权限：
  - ☑️ 勾选 → 只有管理员可以访问（忽略用户组设置）
  - ☐ 不勾选 → 根据用户组规则判断

启用：
  - ☑️ 勾选 → 权限控制生效
  - ☐ 不勾选 → 所有人都可以访问（相当于公开页面）
```

#### 4. 排序
```
排序：数字越小越靠前显示（如：10, 20, 30...）
```

### 编辑现有权限

1. 在列表页点击页面名称进入编辑
2. 修改权限配置
3. 点击保存

系统会提示："权限配置已更新：XXX。用户需要重新登录才能看到变化。"

### 删除权限配置

1. 在列表页勾选要删除的记录
2. 选择操作下拉框：**删除所选的页面访问权限**
3. 确认删除

## 🔐 权限规则说明

### 优先级（从高到低）

1. **管理员优先**
   - 所有 `is_staff=True` 的用户始终拥有所有页面的访问权限
   - 即使没有在用户组中，管理员也能访问

2. **未启用控制**
   - 如果权限配置的"启用"未勾选
   - 则所有登录用户都可以访问该页面

3. **需要管理员权限**
   - 如果勾选了"需要管理员权限"
   - 只有 `is_staff=True` 的用户可以访问
   - 忽略用户组设置

4. **用户组规则**
   - 检查用户是否属于"允许的用户组"
   - 如果用户在任何一个允许的组中 → 可以访问
   - 如果没有设置任何允许的组 → 所有登录用户可访问

### 配置示例

#### 示例1：只允许特定组访问
```
页面名称：计划书分步骤分析
允许的用户组：plan_analyzer
需要管理员权限：☐
启用：☑️

结果：
✅ 管理员可以访问
✅ plan_analyzer 组的成员可以访问
❌ 其他普通用户无法访问
```

#### 示例2：只允许管理员访问
```
页面名称：系统设置
允许的用户组：（不选择）
需要管理员权限：☑️
启用：☑️

结果：
✅ 只有管理员可以访问
❌ 所有普通用户无法访问（即使在某个组中）
```

#### 示例3：所有人都可以访问
```
页面名称：计划书管理
允许的用户组：（不选择）
需要管理员权限：☐
启用：☑️

结果：
✅ 所有登录用户都可以访问
```

#### 示例4：多个组都可以访问
```
页面名称：高级功能
允许的用户组：premium_users, plan_analyzer, vip_members
需要管理员权限：☐
启用：☑️

结果：
✅ 管理员可以访问
✅ premium_users 组的成员可以访问
✅ plan_analyzer 组的成员可以访问
✅ vip_members 组的成员可以访问
❌ 其他普通用户无法访问
```

## 👥 管理用户组

### 创建新用户组
1. 进入：**Authentication and Authorization** → **Groups**
2. 点击**增加组**
3. 输入组名（如：premium_users）
4. （可选）选择该组的权限
5. 保存

### 将用户添加到组
方式1：通过用户管理
1. 进入：**Authentication and Authorization** → **Users**
2. 点击用户名
3. 找到**Groups**部分
4. 从"Available groups"移动到"Chosen groups"
5. 保存

方式2：通过命令行脚本
```bash
python3 manage_user_permissions.py add username
```

## 🔄 权限生效时机

### 重要提示
⚠️ **用户需要重新登录**才能看到权限变化！

### 原因
- 用户的权限信息在登录时加载并缓存在前端 localStorage
- 修改后台权限配置不会立即影响已登录的用户
- 用户退出并重新登录后，会重新获取最新的权限信息

### 如何让权限立即生效
1. **通知用户**：告知用户需要退出并重新登录
2. **清除缓存**：用户可以清除浏览器 localStorage
3. **等待自然过期**：Token 过期后会自动刷新

## 📋 常见任务速查

### 任务1：新增一个受限页面
```
1. 在 Django Admin 创建 PagePermission 记录
2. 设置页面名称、代码、路由
3. 选择允许的用户组
4. 勾选"启用"
5. 保存
```

### 任务2：授予用户访问权限
```
方式1：将用户添加到对应的用户组
方式2：将该用户组添加到页面的"允许的用户组"
```

### 任务3：临时开放某个页面给所有人
```
1. 编辑该页面的权限配置
2. 取消勾选"启用"
3. 保存

或者：
1. 移除所有"允许的用户组"
2. 确保"需要管理员权限"未勾选
3. 保存
```

### 任务4：限制某个页面只允许管理员访问
```
1. 编辑该页面的权限配置
2. 勾选"需要管理员权限"
3. 保存
```

## 🎨 前端效果

### 有权限的用户
- 在 Dashboard 可以看到该页面的卡片
- 点击卡片可以正常访问

### 无权限的用户
- Dashboard 不会显示该页面的卡片
- 即使知道URL也无法访问（前端会隐藏）

## 🛡️ 安全建议

1. **最小权限原则**
   - 只给需要的用户授予必要的权限
   - 定期审查用户组成员

2. **管理员账号安全**
   - 管理员账号拥有所有权限，务必保护好密码
   - 不要随意设置用户为管理员

3. **定期审计**
   - 定期检查页面权限配置
   - 移除离职员工的用户组成员资格

4. **敏感功能保护**
   - 对敏感功能使用"需要管理员权限"
   - 或创建专门的用户组进行精细控制

## 📚 相关文档

- `PLAN_ANALYZER_PERMISSIONS.md` - 命令行权限管理指南
- `PERMISSION_QUICKSTART.md` - 快速开始指南
- `manage_user_permissions.py` - 命令行管理脚本
- `init_page_permissions.py` - 初始化脚本

## 🆘 故障排查

### 问题：用户看不到权限变化
**解决方法**：
1. 确认权限配置已保存
2. 让用户退出并重新登录
3. 或清除浏览器 localStorage

### 问题：所有人都看不到某个页面
**检查清单**：
1. 权限配置是否启用？
2. 是否勾选了"需要管理员权限"？
3. 是否设置了允许的用户组但用户不在组内？

### 问题：管理员也看不到某个页面
**可能原因**：
1. 权限配置未启用 ✓ 勾选"启用"
2. 用户不是真正的管理员 ✓ 检查 is_staff 字段

## 💡 高级技巧

### 技巧1：批量管理用户权限
使用命令行脚本批量操作：
```bash
# 批量授权
for user in alice bob charlie; do
    python3 manage_user_permissions.py add $user
done
```

### 技巧2：动态权限管理
在 Django Admin 中可以随时调整权限，无需修改代码或重启服务。

### 技巧3：临时测试
创建测试用户和测试组，验证权限配置是否正确。
